#!/usr/bin/env python

import optparse
import select
import sys

parser = optparse.OptionParser()
parser.add_option('-n','--name',dest='name',
      help='name of this meter')
parser.set_defaults(daemon=False)
flags, args = parser.parse_args()

import socket
import struct

MCAST_ADDR = "224.107.101.103"
MCAST_PORT = 9012

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)
sock.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, 2)

def publish(val):
  print val
  m = struct.pack('!I', val)
  sock.sendto(m, (MCAST_ADDR, MCAST_PORT))

def main(name):
  fd = open('/dev/ttyUSB0', 'rb')
  while True:
    rr, _, _ = select.select([fd], [], [])
    buf = fd.readline().strip()
    if buf:
      try:
        v = int(buf)
        publish(v)
      except ValueError:
        pass


if __name__ == '__main__':
  main(flags.name)
